---
name: Build and Push - Docker
description: Builds and pushes docker image to Docker Hub via Packer
inputs:
  packer-path:
    required: true
    description: "Path to packer file"

runs:
  using: "composite"
  steps:
    - name: Set Packer Variables
      env:
        PKR_VAR_docker_username: ${{ secrets.DOCKER_USERNAME }}
        PKR_VAR_docker_token: ${{ secrets.DOCKER_TOKEN }}
      shell: bash
      run: |
        echo "Packer environment variables set."

    - name: Setup `packer`
      uses: hashicorp/setup-packer@main
      id: setup
      with:
        version: "latest"

    - name: Run `packer init`
      id: init
      shell: bash
      run: "packer init ${{ inputs.packer-path }}"

    - name: Run `packer validate`
      id: validate
      shell: bash
      run: "packer validate ${{ inputs.packer-path }}"

    - name: Build Artifact
      shell: bash
      run: |
        packer build -color=false -on-error=abort ${{ inputs.packer-path }}